generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ==========================================
// 1. KÄ°MLÄ°K VE YETKÄ°LENDÄ°RME
// ==========================================

model User {
  id            Int       @id @default(autoincrement())
  email         String    @unique
  passwordHash  String
  firstName     String
  lastName      String
  phoneNumber   String?
  
  isActive      Boolean   @default(true)

  // ðŸ‘‡ YENÄ° EKLENEN: Rol Ä°liÅŸkisi
  roleId        Int?
  role          Role?     @relation(fields: [roleId], references: [id])
  
  // AUDIT & SOFT DELETE
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime?
  
  // Ä°liÅŸkiler
  loginAudits            LoginAudit[]
  auditLogs              AuditLog[]
  residencies            Residency[]
  ownedUnits             Unit[]  @relation("UnitLandlord")
  debts                  Debt[]
  createdTasks           ScheduledTask[]
  notifications          Notification[]
  notificationPreferences NotificationPreference[]
  announcementReads      AnnouncementRead[]
  pollResponses         PollResponse[]
  createdPolls          Poll[]
}

model Role {
  id          Int       @id @default(autoincrement())
  name        String    @unique // "Super Admin", "Resident"
  description String?
  isSystem    Boolean   @default(false) // true ise silinemez
  
  users       User[]
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  permissions RolePermission[]
}

model Permission {
  id          Int              @id @default(autoincrement())
  slug        String           @unique // 'finance.create'
  description String?
  module      String           // 'FINANCE'
  
  roles       RolePermission[]
}

model RolePermission {
  roleId       Int
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permissionId Int
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
}

// ==========================================
// 2. GÃœVENLÄ°K VE DENETÄ°M
// ==========================================

model LoginAudit {
  id            Int      @id @default(autoincrement())
  userId        Int?
  user          User?    @relation(fields: [userId], references: [id])
  ipAddress     String?
  status        String   // SUCCESS, FAILED
  failureReason String?  
  createdAt     DateTime @default(now())
}

model AuditLog {
  id          Int      @id @default(autoincrement())
  userId      Int?
  user        User?    @relation(fields: [userId], references: [id])
  action      String   // CREATE, UPDATE, DELETE
  resource    String   // User, Site, Expense
  oldValue    Json?
  newValue    Json?
  createdAt   DateTime @default(now())
}

// =========================================================
// 3. MÃœLK YÃ–NETÄ°MÄ° (PROPERTY DOMAIN)
// =========================================================

model Site {
  id          Int       @id @default(autoincrement())
  name        String
  address     String?
  city        String?
  defaultDues Decimal   @db.Decimal(10, 2) @default(0)
  
  blocks      Block[]
  expenses    Expense[]
  announcements Announcement[]
  polls       Poll[]
  
  // Audit Fields
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  
  createdById Int?
  updatedById Int?
  deletedById Int?
}

model Block {
  id        Int       @id @default(autoincrement())
  siteId    Int
  site      Site      @relation(fields: [siteId], references: [id])
  name      String
  
  units     Unit[]
  
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  
  createdById Int?
  updatedById Int?
  deletedById Int?
}

model Unit {
  id          Int         @id @default(autoincrement())
  blockId     Int
  block       Block       @relation(fields: [blockId], references: [id])
  unitNumber  String
  floor       Int?
  shareOfLand Decimal?    @db.Decimal(5, 2)
  landlordId  Int?
  landlord    User?     @relation("UnitLandlord", fields: [landlordId], references: [id])
  debts       Debt[]
  
  residencies Residency[]
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  deletedAt   DateTime?
  
  createdById Int?
  updatedById Int?
  deletedById Int?
}

model Residency {
  id          Int             @id @default(autoincrement())
  unitId      Int
  unit        Unit            @relation(fields: [unitId], references: [id])
  userId      Int
  user        User            @relation(fields: [userId], references: [id])
  type        ResidencyType   
  status      ResidencyStatus @default(ACTIVE)
  
  moveInDate  DateTime?
  moveOutDate DateTime?
  
  // debts       Debt[] // (Ä°leride Finans modÃ¼lÃ¼yle eklenecek)
  
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  deletedAt   DateTime?
}

// =========================================================
// 4. FÄ°NANS VE OPERASYON (YENÄ° EKLENENLER)
// =========================================================

model Expense {
  id            Int               @id @default(autoincrement())
  siteId        Int
  site          Site              @relation(fields: [siteId], references: [id])
  amount        Decimal           @db.Decimal(10, 2)
  description   String
  date          DateTime
  
  // Gider TÃ¼rÃ¼: Ä°ÅŸletme mi, DemirbaÅŸ mÄ±?
  type          ExpenseType       @default(OPERATIONAL)
  
  status        TransactionStatus @default(CONFIRMED)

  // Audit
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  deletedAt     DateTime?
  createdById   Int?
  updatedById   Int?
  deletedById   Int?
}

model Debt {
  id            Int               @id @default(autoincrement())
  
  // Kime borÃ§ yazÄ±ldÄ±?
  payerId       Int
  payer         User              @relation(fields: [payerId], references: [id])
  
  // Hangi daire iÃ§in?
  unitId        Int
  unit          Unit              @relation(fields: [unitId], references: [id])
  
  amount        Decimal           @db.Decimal(10, 2)
  description   String?
  type          ExpenseType       // Borcun kaynaÄŸÄ± (Aidat/DemirbaÅŸ)
  
  dueDate       DateTime
  isPaid        Boolean           @default(false)
  status        TransactionStatus @default(CONFIRMED)
  
  payments      Payment[]

  // Audit
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  deletedAt     DateTime?
}

model Payment {
  id            Int               @id @default(autoincrement())
  debtId        Int
  debt          Debt              @relation(fields: [debtId], references: [id])
  amount        Decimal           @db.Decimal(10, 2)
  paymentDate   DateTime          @default(now())
  paymentMethod String            // CASH, TRANSFER, CREDIT_CARD
  status        TransactionStatus @default(CONFIRMED)
  
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  deletedAt     DateTime?
  createdById   Int?              // Ã–demeyi sisteme giren admin
}

// ENUMS
enum ResidencyType {
  OWNER
  TENANT
}

enum ResidencyStatus {
  ACTIVE
  MOVED_OUT
}

enum ExpenseType {
  OPERATIONAL // KiracÄ±/Oturan Ã¶der
  CAPITAL     // Ev Sahibi Ã¶der
}

enum TransactionStatus {
  CONFIRMED
  CANCELED
}

// =========================================================
// 5. SCHEDULED TASKS / ROBOT SÄ°STEMÄ°
// =========================================================

model ScheduledTask {
  id              Int       @id @default(autoincrement())
  name            String
  description     String?
  handlerName     String    // Handler dosyasÄ±nÄ±n adÄ± (Ã¶rn: "monthly-dues-report")
  cronExpression  String?   // Cron expression (Ã¶rn: "0 0 * * *")
  scheduleType    ScheduleType
  intervalValue   Int?      // Interval iÃ§in (saniye cinsinden)
  startDate       DateTime?
  endDate         DateTime?
  status          TaskStatus @default(ACTIVE)
  maxRetries      Int       @default(3)
  retryDelay      Int       @default(60) // saniye
  payload         Json?     // Handler'a gÃ¶nderilecek parametreler
  config          Json?     // Ek konfigÃ¼rasyonlar
  
  createdById     Int?
  createdBy       User?     @relation(fields: [createdById], references: [id])
  executions      TaskExecution[]
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?
}

model TaskExecution {
  id              Int       @id @default(autoincrement())
  taskId          Int
  task            ScheduledTask @relation(fields: [taskId], references: [id])
  status          ExecutionStatus
  startedAt       DateTime
  completedAt     DateTime?
  duration        Int?      // milisaniye
  result          Json?     // Execution sonucu
  error           String?   @db.Text // Hata mesajÄ±
  retryCount      Int       @default(0)
  
  createdAt       DateTime  @default(now())
}

enum ScheduleType {
  CRON      // Cron expression ile
  INTERVAL  // Her X saniyede bir
  ONCE      // Tek seferlik
}

enum TaskStatus {
  ACTIVE
  PAUSED
  COMPLETED
  FAILED
  DISABLED
}

enum ExecutionStatus {
  RUNNING
  SUCCESS
  FAILED
  CANCELLED
}

// =========================================================
// 6. BÄ°LDÄ°RÄ°M SÄ°STEMÄ° (NOTIFICATION SYSTEM)
// =========================================================

model NotificationTemplate {
  id          Int       @id @default(autoincrement())
  code        String    @unique // "payment.created", "debt.overdue", "welcome.email"
  name        String
  description String?
  category    String    // "PAYMENT", "DEBT", "ANNOUNCEMENT", "SYSTEM"
  channel     NotificationChannel
  
  subject     String?   // Email subject veya SMS baÅŸlÄ±k
  bodyHtml    String?   @db.Text // HTML template
  bodyText    String?   @db.Text // Plain text template
  
  variables   Json?     // Template deÄŸiÅŸkenleri Ã¶rneÄŸi: {"userName": "string", "amount": "number"}
  
  isActive    Boolean   @default(true)
  isSystem    Boolean   @default(false) // System template'ler silinemez
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  
  notifications Notification[]
}

model Notification {
  id              Int       @id @default(autoincrement())
  userId          Int
  user            User      @relation(fields: [userId], references: [id])
  
  templateId     Int?
  template        NotificationTemplate? @relation(fields: [templateId], references: [id])
  
  channel         NotificationChannel
  status          NotificationStatus   @default(PENDING)
  
  recipient       String    // Email veya telefon numarasÄ±
  subject         String?
  body            String    @db.Text
  bodyHtml        String?   @db.Text
  
  variables       Json?     // GÃ¶nderim sÄ±rasÄ±nda kullanÄ±lan deÄŸiÅŸkenler
  
  sentAt          DateTime?
  failedAt        DateTime?
  failureReason   String?   @db.Text
  
  retryCount      Int       @default(0)
  maxRetries      Int       @default(3)
  
  metadata        Json?     // Ek bilgiler (event type, resource id, vb.)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model NotificationPreference {
  id              Int       @id @default(autoincrement())
  userId          Int
  user            User      @relation(fields: [userId], references: [id])
  
  category        String    // "PAYMENT", "DEBT", "ANNOUNCEMENT", "SYSTEM", "ALL"
  channel         NotificationChannel
  
  enabled         Boolean   @default(true)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@unique([userId, category, channel])
  @@index([userId])
}

enum NotificationChannel {
  EMAIL
  SMS
  PUSH
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  CANCELLED
}

// =========================================================
// 7. DOSYA YÃ–NETÄ°MÄ° (FILE MANAGEMENT)
// =========================================================

model File {
  id              Int       @id @default(autoincrement())
  originalName    String    // KullanÄ±cÄ±nÄ±n yÃ¼klediÄŸi dosya adÄ±
  storedName      String    // Sunucuda saklanan dosya adÄ± (UUID + original name)
  path            String    // Dosya yolu (uploads/2025/12/01/uuid-filename.pdf)
  mimeType        String    // MIME type (application/pdf, image/jpeg, vb.)
  size            BigInt    // Dosya boyutu (bytes)
  category        FileCategory @default(GENERAL)
  storageType     StorageType @default(LOCAL)
  status          FileStatus @default(ACTIVE)
  
  // Ä°liÅŸkiler
  attachments     FileAttachment[]
  
  // Audit
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?
  createdById     Int?
  updatedById     Int?
  deletedById     Int?
  
  @@index([category])
  @@index([status])
  @@index([storageType])
  @@index([deletedAt])
}

model FileAttachment {
  id              Int       @id @default(autoincrement())
  fileId          Int
  file            File      @relation(fields: [fileId], references: [id], onDelete: Cascade)
  
  // Polymorphic relation: Hangi entity'ye ait?
  entityType      String    // "Expense", "Site", "Unit", "Announcement", vb.
  entityId        Int       // Ä°lgili entity'nin ID'si
  
  description     String?   // Opsiyonel aÃ§Ä±klama
  
  // Audit
  createdAt       DateTime  @default(now())
  createdById     Int?
  
  @@index([entityType, entityId])
  @@index([fileId])
}

enum FileCategory {
  EXPENSE        // Gider dosyalarÄ±
  ANNOUNCEMENT   // Duyuru dosyalarÄ±
  CONTRACT       // SÃ¶zleÅŸme dosyalarÄ±
  GENERAL        // Genel dosyalar
  REPORT         // Rapor dosyalarÄ±
  INVOICE        // Fatura dosyalarÄ±
  POLL           // Anket dosyalarÄ±
}

enum FileStatus {
  ACTIVE
  DELETED
}

enum StorageType {
  LOCAL  // Local disk storage
  S3     // AWS S3 (ileride)
  AZURE  // Azure Blob Storage (ileride)
}

// =========================================================
// 8. DUYURU YÃ–NETÄ°MÄ° (ANNOUNCEMENT SYSTEM)
// =========================================================

model Announcement {
  id              Int       @id @default(autoincrement())
  title           String
  content         String   @db.Text // HTML destekli iÃ§erik
  category        AnnouncementCategory
  priority        AnnouncementPriority @default(NORMAL)
  status          AnnouncementStatus @default(DRAFT)
  
  // Site iliÅŸkisi (opsiyonel - tÃ¼m site iÃ§in)
  siteId          Int?
  site            Site?    @relation(fields: [siteId], references: [id])
  
  // YayÄ±n ve son geÃ§erlilik tarihleri
  publishedAt     DateTime?
  expiresAt       DateTime?
  
  // Sabitleme
  isPinned        Boolean  @default(false)
  
  // Hedef kitle yÃ¶netimi
  targetAudience  TargetAudienceType @default(ALL)
  targetIds       Json?   // Hedef ID'ler (blok, daire veya kullanÄ±cÄ± ID'leri array)
  
  // Ä°liÅŸkiler
  reads           AnnouncementRead[]
  
  // Audit
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?
  createdById     Int?
  updatedById     Int?
  deletedById     Int?
  
  @@index([status])
  @@index([category])
  @@index([priority])
  @@index([siteId])
  @@index([publishedAt])
  @@index([expiresAt])
  @@index([isPinned])
  @@index([deletedAt])
}

model AnnouncementRead {
  id              Int       @id @default(autoincrement())
  announcementId  Int
  announcement    Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  userId          Int
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  readAt          DateTime  @default(now())
  isRead          Boolean   @default(true)
  
  @@unique([announcementId, userId])
  @@index([announcementId])
  @@index([userId])
}

enum AnnouncementCategory {
  GENEL      // Genel duyurular
  ACIL       // Acil duyurular
  BAKIM      // BakÄ±m duyurularÄ±
  FINANS     // Finansal duyurular
  TOPLANTI   // ToplantÄ± duyurularÄ±
  ETKINLIK   // Etkinlik duyurularÄ±
  DIGER      // DiÄŸer
}

enum AnnouncementPriority {
  LOW       // DÃ¼ÅŸÃ¼k Ã¶ncelik
  NORMAL    // Normal Ã¶ncelik
  HIGH      // YÃ¼ksek Ã¶ncelik
  URGENT    // Acil Ã¶ncelik
}

enum AnnouncementStatus {
  DRAFT     // Taslak
  PUBLISHED // YayÄ±nda
  ARCHIVED  // ArÅŸivlendi
  EXPIRED   // SÃ¼resi doldu
}

enum TargetAudienceType {
  ALL       // TÃ¼m kullanÄ±cÄ±lar
  SITE      // Belirli site
  BLOCKS    // Belirli bloklar
  UNITS     // Belirli daireler
  USERS     // Belirli kullanÄ±cÄ±lar
}

// =========================================================
// 9. ANKET YÃ–NETÄ°MÄ° (POLL/SURVEY SYSTEM)
// =========================================================

model Poll {
  id              Int       @id @default(autoincrement())
  title           String
  description     String?   @db.Text
  status          PollStatus @default(DRAFT)
  
  // Site iliÅŸkisi (opsiyonel)
  siteId          Int?
  site            Site?     @relation(fields: [siteId], references: [id])
  
  // OluÅŸturan kullanÄ±cÄ±
  createdById     Int
  createdBy       User      @relation(fields: [createdById], references: [id])
  
  // Tarihler
  startDate       DateTime? // BaÅŸlangÄ±Ã§ tarihi (opsiyonel)
  endDate         DateTime? // BitiÅŸ tarihi (opsiyonel)
  
  // GÃ¶rÃ¼nÃ¼rlÃ¼k ve dÃ¼zenlenebilirlik ayarlarÄ±
  resultVisibility PollResultVisibility @default(AFTER_CLOSED)
  responseEditable PollResponseEditable @default(UNTIL_CLOSED)
  
  // Hedef kitle yÃ¶netimi
  targetAudience  TargetAudienceType @default(ALL)
  targetIds       Json?   // Hedef ID'ler (blok, daire veya kullanÄ±cÄ± ID'leri array)
  
  // Ä°liÅŸkiler
  questions       PollQuestion[]
  responses       PollResponse[]
  
  // Audit
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?
  updatedById     Int?
  deletedById     Int?
  
  @@index([status])
  @@index([siteId])
  @@index([createdById])
  @@index([startDate])
  @@index([endDate])
  @@index([deletedAt])
}

model PollQuestion {
  id              Int       @id @default(autoincrement())
  pollId          Int
  poll            Poll      @relation(fields: [pollId], references: [id], onDelete: Cascade)
  
  questionText    String    @db.Text
  questionType    PollQuestionType
  order           Int       @default(0) // Soru sÄ±rasÄ±
  isRequired      Boolean   @default(false)
  
  // Ä°liÅŸkiler
  options         PollOption[]
  answers         PollResponseAnswer[]
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([pollId])
  @@index([order])
}

model PollOption {
  id              Int       @id @default(autoincrement())
  questionId     Int
  question        PollQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  
  optionText      String
  order           Int       @default(0) // SeÃ§enek sÄ±rasÄ±
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([questionId])
  @@index([order])
}

model PollResponse {
  id              Int       @id @default(autoincrement())
  pollId          Int
  poll            Poll      @relation(fields: [pollId], references: [id], onDelete: Cascade)
  
  userId          Int
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Ä°liÅŸkiler
  answers         PollResponseAnswer[]
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@unique([pollId, userId])
  @@index([pollId])
  @@index([userId])
}

model PollResponseAnswer {
  id              Int       @id @default(autoincrement())
  responseId      Int
  response        PollResponse @relation(fields: [responseId], references: [id], onDelete: Cascade)
  
  questionId      Int
  question        PollQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  
  // YanÄ±t verisi (farklÄ± tipler iÃ§in)
  answerText      String?   @db.Text // Metin yanÄ±tlarÄ± iÃ§in
  answerNumber    Decimal?  @db.Decimal(10, 2) // SayÄ±sal yanÄ±tlar iÃ§in
  answerDate      DateTime? // Tarih yanÄ±tlarÄ± iÃ§in
  selectedOptionIds Json?   // SeÃ§ilen seÃ§enek ID'leri (SINGLE_CHOICE veya MULTIPLE_CHOICE iÃ§in)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@unique([responseId, questionId])
  @@index([responseId])
  @@index([questionId])
}

enum PollStatus {
  DRAFT     // Taslak
  PUBLISHED // YayÄ±nda
  CLOSED    // KapatÄ±ldÄ±
  ARCHIVED  // ArÅŸivlendi
}

enum PollQuestionType {
  SINGLE_CHOICE   // Tek seÃ§im (radio button)
  MULTIPLE_CHOICE // Ã‡oklu seÃ§im (checkbox)
  SHORT_TEXT      // KÄ±sa metin (input)
  LONG_TEXT       // Uzun metin (textarea)
  NUMBER          // SayÄ±sal deÄŸer
  DATE            // Tarih seÃ§imi
}

enum PollResultVisibility {
  PUBLIC        // Herkese aÃ§Ä±k (anket aÃ§Ä±kken bile)
  PRIVATE       // Sadece anket sahibi/admin
  AFTER_CLOSED  // Anket kapandÄ±ktan sonra herkese aÃ§Ä±k
}

enum PollResponseEditable {
  ALWAYS        // Ä°stediÄŸi zaman deÄŸiÅŸtirebilir
  UNTIL_CLOSED  // Anket kapanana kadar deÄŸiÅŸtirebilir
  NEVER         // Bir kez yanÄ±t verildikten sonra deÄŸiÅŸtirilemez
}